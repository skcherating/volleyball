<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Volleyball Manager Pro</title>
    <style>
        :root { 
            --primary: #2563eb; 
            --secondary: #dc2626; 
            --bg: #f8fafc; 
            --court-orange: #f97316;
            --court-blue: #3b82f6;
            --dark: #0f172a;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 0; margin: 0; color: #333; min-height: 100vh; }
        
        /* --- LOGIN OVERLAY --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); z-index: 9999;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .login-logo { width: 80px; margin-bottom: 15px; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .btn-login { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-login:hover { background: #1d4ed8; }
        .login-error { color: var(--secondary); font-size: 0.9rem; margin-top: 10px; display: none; }

        /* --- APP CONTAINER --- */
        #app-container { display: none; max-width: 1000px; margin: 15px auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding-bottom: 40px; }
        
        /* --- HEADER --- */
        .user-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .user-info { font-size: 0.8rem; color: #64748b; font-weight: bold; }
        .btn-logout { background: #94a3b8; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }

        .header-section { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .school-logo { width: 50px; height: auto; margin-bottom: 5px; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--dark); }
        .match-meta { display: flex; justify-content: center; gap: 10px; margin-top: 5px; flex-wrap: wrap; }
        .meta-group { display: flex; align-items: center; gap: 5px; }
        .meta-label { font-size: 0.7rem; font-weight: bold; color: #64748b; text-transform: uppercase; }
        .meta-input { border: 1px solid #cbd5e1; padding: 4px; border-radius: 4px; font-size: 0.8rem; width: 130px; }

        .no-print { display: block; }

        /* --- SCOREBOARD --- */
        .scoreboard-panel { background: var(--dark); color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .sb-grid { display: grid; grid-template-columns: 1fr 0.8fr 1fr; gap: 10px; align-items: start; text-align: center; }
        .team-col { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .team-name { font-size: 0.85rem; font-weight: bold; opacity: 0.9; text-transform: uppercase; }
        .big-score { font-size: 3rem; font-weight: 800; line-height: 1; font-variant-numeric: tabular-nums; }
        .game-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: rgba(255,255,255,0.1); padding: 4px; border-radius: 6px; margin-top: 5px; width: 100%; }
        .stat-box { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 0.55rem; opacity: 0.7; text-transform: uppercase; }
        .to-dots { display: flex; gap: 4px; margin-top: 2px; }
        .to-dot { width: 10px; height: 10px; border-radius: 50%; background: #475569; border: 1px solid #94a3b8; cursor: pointer; }
        .to-dot.active { background: #ef4444; border-color: #ef4444; box-shadow: 0 0 5px #ef4444; }
        .sub-counter { font-size: 0.8rem; font-weight: bold; font-variant-numeric: tabular-nums; cursor: pointer; }
        .score-controls { display: flex; gap: 5px; margin-top: 5px; }
        .btn-score { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); width: 32px; height: 32px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-win-set { background: #10b981; color: white; border: none; padding: 5px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 5px; width: 100%; }
        .btn-win-set.loss { background: #ef4444; }
        .sets-col { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100%; padding-top: 5px; }
        .sets-label { font-size: 0.65rem; text-transform: uppercase; color: #94a3b8; letter-spacing: 1px; }
        .sets-val { font-size: 1.8rem; font-weight: bold; margin-bottom: 5px; }
        .sets-controls-row { display: flex; gap: 3px; margin-bottom: 10px; justify-content: center; }
        .btn-set { background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: #cbd5e1; font-size: 0.65rem; padding: 4px 6px; border-radius: 4px; cursor: pointer; }
        .btn-reset-pts { background: rgba(234, 179, 8, 0.2); border: 1px solid #eab308; color: #fde047; }
        .btn-reset-match { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #fca5a5; font-size: 0.65rem; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        .history-section { margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .history-chips { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin-top: 5px; }
        .history-chip { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; }

        /* --- TABS --- */
        .tabs-nav { display: flex; margin-bottom: 15px; border-bottom: 2px solid #e2e8f0; }
        .tab-btn { flex: 1; padding: 12px 5px; font-weight: bold; cursor: pointer; background: var(--bg); border: none; color: #64748b; font-size: 0.85rem; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TAB 1: ROTATION --- */
        .roster-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .roster-col { background: #f1f5f9; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .roster-row { display: grid; grid-template-columns: 20px 1fr 50px; gap: 4px; align-items: center; margin-bottom: 3px; }
        .roster-row span { font-size: 0.7rem; color: #888; font-weight: bold; text-align: center; }
        .roster-row input, .roster-row select { padding: 4px; border: 1px solid #cbd5e1; border-radius: 3px; font-size: 0.85rem; width: 100%; }
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .team-box { padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0; background: white; }
        .lineup-row { display: grid; grid-template-columns: 30px 1fr 30px 1fr; gap: 4px; align-items: center; margin-bottom: 6px; }
        .lineup-row label { font-size: 0.75rem; font-weight: bold; color: #555; }
        .lineup-select { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; background: white; }
        .icon-swap { font-size: 1rem; cursor: pointer; color: #94a3b8; text-align: center; }
        .output-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .rotation-card { border: 2px solid #334155; border-radius: 8px; padding: 10px; background: #fff; page-break-inside: avoid; }
        .rot-title { text-align: center; font-weight: bold; font-size: 0.9rem; margin-bottom: 8px; background: #334155; color: white; padding: 4px; border-radius: 4px; }
        .court { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; background: #fbbf24; padding: 5px; border: 2px solid #92400e; border-radius: 4px; margin-bottom: 10px; }
        .court.team-b-bg { background: #f87171; border-color: #991b1b; }
        .zone { background: rgba(255,255,255,0.95); height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; border-radius: 2px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .pos-label { font-size: 0.55rem; color: #64748b; position: absolute; top: 2px; left: 2px; }
        .player-content { display: flex; flex-direction: column; align-items: center; line-height: 1.1; width: 100%; overflow: hidden; }
        .role-badge { font-size: 0.6rem; background: #333; color: white; padding: 1px 4px; border-radius: 3px; margin-bottom: 2px; }
        .role-badge.libero { background: #eab308; color: black; } 
        .sub-name { font-size: 0.7rem; color: #dc2626; font-style: italic; margin-top: 1px; }
        .server-badge { position: absolute; top: 2px; right: 2px; background: #10b981; color: white; font-size: 0.55rem; padding: 1px 3px; border-radius: 3px; }

        /* --- TAB 2: ANALYSIS (UPDATED LAYOUT) --- */
        .analysis-section { padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
        .analysis-header { font-weight: bold; text-align: center; margin-bottom: 10px; color: #475569; font-size: 0.9rem; text-transform: uppercase; }
        
        /* Layout Grid: Left (List) -> Right (Map) */
        .analysis-wrapper { display: grid; grid-template-columns: 280px 1fr; gap: 20px; align-items: start; }
        
        /* Player List (Now on the Left) */
        .stats-col { background: white; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; min-height: 420px; max-height: 600px; overflow-y: auto; }
        .stats-title { font-size: 0.8rem; font-weight: bold; color: #64748b; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .server-list { display: flex; flex-direction: column; gap: 8px; }
        .server-item { padding: 8px; border-radius: 6px; background: #f8fafc; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.2s; }
        .server-item:hover { background: #e2e8f0; }
        .server-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .server-info { display: flex; align-items: center; gap: 8px; }
        .color-swatch { width: 12px; height: 12px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.2); }
        .total-badge { background: #334155; color: white; font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; }
        .stat-badges { display: flex; flex-wrap: wrap; gap: 4px; }
        .stat-badge { background: white; border: 1px solid #cbd5e1; color: #334155; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .stat-badge.best-zone { background-color: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: scale(1.05); }

        /* Visual Court (Now on the Right and Bigger) */
        .map-col { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .serve-input-row { display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px; }
        .serve-input { padding: 8px; border: 2px solid #3b82f6; border-radius: 6px; width: 160px; text-align: center; font-weight: bold; font-size: 1rem; }
        
        .map-scroll-container { max-height: 600px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: white; margin-bottom: 10px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        
        /* BIGGER COURT */
        .analysis-container { 
            position: relative; 
            width: 420px; /* Increased from 300px */
            height: 420px; /* Increased from 300px */
            background: var(--court-orange); border: 4px solid white; 
            box-shadow: 0 0 0 10px var(--court-blue); cursor: crosshair; margin: 20px 10px 30px 10px;
        }
        .net-indicator { position: absolute; top: -25px; left: -10px; right: -10px; height: 10px; background: repeating-linear-gradient(90deg, #e5e5e5, #e5e5e5 2px, #333 2px, #333 4px); border: 1px solid #000; display: flex; align-items: center; justify-content: center; z-index: 5; }
        .net-text-badge { background: white; color: black; font-size: 0.8rem; font-weight: 800; padding: 2px 10px; border-radius: 4px; border: 1px solid #333; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; }
        .analysis-cell { border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: rgba(255,255,255,0.4); font-weight:bold; font-size: 1.5rem; }
        .analysis-cell:nth-child(1), .analysis-cell:nth-child(2), .analysis-cell:nth-child(3) { border-bottom: 3px solid white; }
        
        .serve-mark { 
            position: absolute; 
            min-width: 28px; width: max-content; padding: 0 6px; box-sizing: border-box; height: 28px; 
            border-radius: 14px; /* Perfectly round if short, pill-shaped if long */
            transform: translate(-50%, -50%); border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.6); 
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 0.8rem; 
            z-index: 10; text-shadow: 0 0 2px black; pointer-events: none; white-space: nowrap;
        }

        /* --- TAB 3: ERROR TRACKING --- */
        .error-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: start; }
        .player-chips { display: flex; flex-wrap: wrap; gap: 8px; padding: 15px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; }
        .player-chip { 
            padding: 8px 10px; min-width: 75px; text-align: center; display: inline-flex; justify-content: center;
            background: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 20px; 
            font-size: 0.85rem; font-weight: bold; color: #475569; cursor: pointer; transition: 0.2s; 
        }
        .player-chip:hover { border-color: var(--primary); color: var(--primary); }
        .player-chip.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 6px rgba(37,99,235,0.4); }
        .error-action-area { display: flex; flex-direction: column; gap: 15px; }
        .error-buttons { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: white; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; }
        .err-btn { padding: 15px 5px; font-size: 1rem; font-weight: bold; border-radius: 8px; border: none; cursor: pointer; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.1s; }
        .err-btn:active { transform: scale(0.95); }
        .err-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .bg-se { background: #f59e0b; } .bg-re { background: #3b82f6; } .bg-ae { background: #ef4444; } 
        .bg-be { background: #8b5cf6; } .bg-bhe { background: #06b6d4; } .bg-fe { background: #64748b; }
        .err-subtext { display: block; font-size: 0.65rem; font-weight: normal; margin-top: 2px; opacity: 0.9; }

        .error-log-panel { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .err-log-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold; color: #475569; }
        .btn-undo-err { background: #94a3b8; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
        .err-player-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #f1f5f9; }
        .err-player-name { font-weight: bold; font-size: 0.9rem; color: #1e293b; width: 100px; }
        .err-badges { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
        .e-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; color: white; }

        /* General Controls */
        .filter-bar { background: #eee; padding: 8px; border-radius: 6px; margin-bottom: 15px; text-align: center; }
        .view-select { padding: 6px; border-radius: 4px; font-weight: bold; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
        .btn-main { padding: 12px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-update { background: var(--dark); flex: 1; }
        .btn-print { background: #10b981; flex: 1; }
        .print-select { padding: 12px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; color: #333; }
        .data-tools { margin-top: 20px; padding: 15px; background: #e2e8f0; border-radius: 8px; display: flex; gap: 10px; align-items: center; justify-content: center; }
        .btn-data { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; font-size: 0.85rem; }
        .btn-export { background: #3b82f6; color: white; }
        .btn-import { background: #64748b; color: white; }
        .btn-reset-all { background: #ef4444; color: white; margin-left: auto; }
        .watermark { text-align: center; font-size: 0.7rem; color: #ccc; margin-top: 20px; font-family: monospace; }

        @media screen and (max-width: 768px) {
            .roster-wrapper, .setup-grid { grid-template-columns: 1fr; }
            .output-grid { grid-template-columns: 1fr; }
            .sb-grid { grid-template-columns: 1fr; gap: 20px; }
            .data-tools { flex-direction: column; width: 100%; gap: 15px; }
            .btn-reset-all { margin-left: 0; width: 100%; }
            .analysis-wrapper { grid-template-columns: 1fr; }
            .analysis-container { width: 300px; height: 300px; } /* Scale down court on mobile */
            .error-layout { grid-template-columns: 1fr; }
            .btn-group { flex-wrap: wrap; }
            .print-select { width: 100%; }
        }

        /* --- PRINT STYLES --- */
        @media print {
            @page { size: A4 portrait; margin: 5mm; }
            body { background: white; padding: 0; margin: 0; }
            .container { box-shadow: none; border: none; padding: 0; margin: 0; width: 100%; max-width: 100%; }
            .no-print, .btn-win-set, .score-controls, .btn-reset-match, .data-tools, .sets-controls-row, .btn-undo, .serve-input-row, .tabs-nav, .user-bar, .error-buttons, .player-chips, .btn-undo-err { display: none !important; }
            .meta-input { border: none; font-weight: bold; padding: 0; }
            
            .tab-content { display: none !important; }
            body.print-all .tab-content { display: block !important; margin-bottom: 20px; }
            body.print-rotations #tab-rotations { display: block !important; }
            body.print-analysis #tab-analysis { display: block !important; }
            body.print-errors #tab-errors { display: block !important; }

            .scoreboard-panel { background: white; border: 1px solid #000; color: black; padding: 5px; margin-bottom: 10px; }
            .big-score { font-size: 2rem; }
            .game-stats { color: black; background: transparent; border: 1px solid #ccc; }
            .to-dot { background: #eee; border-color: #000; }
            .to-dot.active { background: #000; }
            
            .analysis-section, .error-log-panel { border: 1px solid #000; background: white; page-break-inside: avoid; }
            .analysis-wrapper { display: grid; grid-template-columns: 250px 1fr; gap: 15px; } /* Force side by side on print */
            .analysis-container { width: 340px; height: 340px; border-color: #000; box-shadow: 0 0 0 5px #ccc; break-inside: avoid; margin: 10px auto; }
            .map-scroll-container { max-height: none; overflow: visible; border: none; padding: 0; }
            .serve-mark { min-width: 24px; height: 24px; border-radius: 12px; font-size: 0.6rem; }
            
            .history-section { border-top: 1px solid #ccc; margin-top: 5px; padding-top: 5px; }
            .history-chip { background: #eee; color: #000; border: 1px solid #ccc; font-size: 0.7rem; padding: 1px 6px; }
            .output-grid { display: grid; grid-template-columns: 49% 49%; column-gap: 2%; row-gap: 8px; }
            .rotation-card { border: 1px solid #000; padding: 4px; break-inside: avoid; }
            .court { border-width: 1px; }
            .watermark { position: fixed; bottom: 5px; right: 5px; }
        }
    </style>
</head>
<body class="print-all">

<div id="login-overlay">
    <div class="login-box">
        <img src="logo_sekolah.jpg" alt="Logo" class="login-logo">
        <h2 style="margin-top:0; color:#0f172a;">SK Cherating Volleyball</h2>
        <input type="text" id="username" class="login-input" placeholder="Username">
        <input type="password" id="password" class="login-input" placeholder="Password">
        <button class="btn-login" onclick="login()">Login</button>
        <div id="login-error" class="login-error">Invalid Username or Password</div>
    </div>
</div>

<div id="app-container" class="container">
    
    <div class="user-bar no-print">
        <div class="user-info">User: <span id="current-user"></span></div>
        <div><button class="btn-logout" onclick="logout()">Logout</button></div>
    </div>

    <div class="header-section">
        <img src="logo_sekolah.jpg" alt="Logo" class="school-logo">
        <h1 style="margin: 0;">Volleyball Manager Pro</h1>
        <div class="match-meta">
            <div class="meta-group"><span class="meta-label">Date:</span><input type="date" id="match-date" class="meta-input" oninput="saveAll()"></div>
            <div class="meta-group"><span class="meta-label">Venue:</span><input type="text" id="match-venue" class="meta-input" placeholder="Gym / Court" oninput="saveAll()"></div>
        </div>
    </div>

    <div class="scoreboard-panel">
        <div class="sb-grid">
            <div class="team-col">
                <div class="team-name" id="sb-name-a">HOME</div>
                <div class="big-score" id="score-a-disp">0</div>
                <div class="game-stats">
                    <div class="stat-box"><span class="stat-label">TIMEOUTS</span><div class="to-dots"><div class="to-dot" id="to-a-1" onclick="toggleTO('a',1)"></div><div class="to-dot" id="to-a-2" onclick="toggleTO('a',2)"></div></div></div>
                    <div class="stat-box"><span class="stat-label">SUBS</span><div class="sub-counter" id="subs-a-disp" onclick="adjSubs('a', 1)">0/12</div></div>
                </div>
                <div class="score-controls no-print">
                    <button class="btn-score" onclick="adjScore('a', -1)">-</button><button class="btn-score" onclick="adjScore('a', 1)">+</button>
                </div>
                <button class="btn-win-set no-print" onclick="finishSet('a')">Win Set</button>
            </div>
            <div class="sets-col">
                <div class="sets-label">SETS WON</div>
                <div class="sets-val"><span id="sets-a-disp">0</span> - <span id="sets-b-disp">0</span></div>
                <div class="sets-controls-row no-print">
                    <button class="btn-set" onclick="updateSet('a', 1)">A+</button><button class="btn-set btn-reset-pts" onclick="resetPointsOnly()">0-0</button><button class="btn-set" onclick="updateSet('b', 1)">B+</button>
                </div>
                <button class="btn-reset-match no-print" onclick="resetMatch()">RESET MATCH</button>
            </div>
            <div class="team-col">
                <div class="team-name" id="sb-name-b">AWAY</div>
                <div class="big-score" id="score-b-disp">0</div>
                <div class="game-stats">
                    <div class="stat-box"><span class="stat-label">TIMEOUTS</span><div class="to-dots"><div class="to-dot" id="to-b-1" onclick="toggleTO('b',1)"></div><div class="to-dot" id="to-b-2" onclick="toggleTO('b',2)"></div></div></div>
                    <div class="stat-box"><span class="stat-label">SUBS</span><div class="sub-counter" id="subs-b-disp" onclick="adjSubs('b', 1)">0/12</div></div>
                </div>
                <div class="score-controls no-print">
                    <button class="btn-score" onclick="adjScore('b', -1)">-</button><button class="btn-score" onclick="adjScore('b', 1)">+</button>
                </div>
                <button class="btn-win-set loss no-print" onclick="finishSet('b')">Win Set</button>
            </div>
        </div>
        <div class="history-section">
            <div class="history-chips" id="history-list"><span style="opacity:0.5; font-size:0.8rem">No sets completed</span></div>
        </div>
    </div>

    <div class="tabs-nav no-print">
        <button class="tab-btn active" onclick="switchTab('rotations')">1. Game Rotations</button>
        <button class="tab-btn" onclick="switchTab('analysis')">2. Serve Analysis</button>
        <button class="tab-btn" onclick="switchTab('errors')">3. Error Tracking</button>
    </div>

    <div id="tab-rotations" class="tab-content active">
        <div class="no-print">
            <div class="filter-bar">
                Display Mode: <select id="view-mode" class="view-select" onchange="generate()"><option value="all">Show All 6</option><option value="1">Rotation 1</option><option value="2">Rotation 2</option><option value="3">Rotation 3</option><option value="4">Rotation 4</option><option value="5">Rotation 5</option><option value="6">Rotation 6</option></select>
            </div>
            <div class="roster-wrapper">
                <div class="roster-col">
                    <div class="team-header"><input type="text" id="name-a" class="team-name-input" value="SK CHERATING" oninput="saveAll(); updateNames()"><div style="font-size:0.8rem;">Start: <select id="start-offset-a" onchange="saveAll(); generate()"><option value="0">1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option><option value="4">5</option><option value="5">6</option></select></div></div>
                    <div class="roster-list" id="roster-list-a"></div>
                </div>
                <div class="roster-col">
                    <div class="team-header"><input type="text" id="name-b" class="team-name-input" value="OPPONENT" oninput="saveAll(); updateNames()"><div style="font-size:0.8rem;">Start: <select id="start-offset-b" onchange="saveAll(); generate()"><option value="0">1</option><option value="1">2</option><option value="2">3</option><option value="3">4</option><option value="4">5</option><option value="5">6</option></select></div></div>
                    <div class="roster-list" id="roster-list-b"></div>
                </div>
            </div>
            <div class="setup-grid">
                <div class="team-box team-a"><div style="text-align:center; font-weight:bold; margin-bottom:5px; color:var(--primary)">STARTING LINEUP A</div><div id="selectors-a"></div></div>
                <div class="team-box team-b"><div style="text-align:center; font-weight:bold; margin-bottom:5px; color:var(--secondary)">STARTING LINEUP B</div><div id="selectors-b"></div></div>
            </div>
        </div>
        <div id="output" class="output-grid"></div>
    </div>

    <div id="tab-analysis" class="tab-content">
        <div class="analysis-section">
            <div class="analysis-header">Opponent Serve Analysis (9-Zone)</div>
            <div class="analysis-wrapper">
                
                <div class="stats-col">
                    <div class="stats-title"><span>CLICK NAME TO SELECT</span><span>ZONES HIT</span></div>
                    <div id="server-stats-list" class="server-list"></div>
                </div>

                <div class="map-col">
                    <div class="serve-input-row">
                        <span style="font-size:0.8rem; font-weight:bold; color:#64748b;">SERVER:</span>
                        <input type="text" id="serve-player-input" class="serve-input" placeholder="Name or #" title="Enter name then click court">
                    </div>
                    
                    <div class="map-scroll-container" id="maps-container">
                        <div class="analysis-container" id="serve-court-0" onclick="recordServe(event, 0)">
                            <div class="net-indicator"><span class="net-text-badge">NET (SET 1)</span></div>
                            <div class="analysis-grid">
                                <div class="analysis-cell">4</div><div class="analysis-cell">3</div><div class="analysis-cell">2</div>
                                <div class="analysis-cell">7</div><div class="analysis-cell">8</div><div class="analysis-cell">9</div>
                                <div class="analysis-cell">5</div><div class="analysis-cell">6</div><div class="analysis-cell">1</div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align:center; margin-top:10px; display:flex; gap:10px; justify-content:center;">
                        <button style="background:#2563eb; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; font-size:0.8rem; cursor:pointer;" onclick="addMap()">+ Add Set Map</button>
                        <button style="background:#64748b; color:white; border:none; padding:6px 12px; border-radius:4px; font-weight:bold; font-size:0.8rem; cursor:pointer;" onclick="undoServeMark(event)">Undo</button>
                    </div>
                    <div style="text-align:center; margin-top:10px;">
                        <button style="background:transparent; border:1px solid #ef4444; color:#ef4444; padding:4px 8px; border-radius:4px; font-size:0.7rem; cursor:pointer;" onclick="resetAnalysisOnly()">Reset Analysis Only</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="tab-errors" class="tab-content">
        <h2 style="text-align:center; margin-top:0; color:#475569; font-size:1.1rem;">Team Error Tracking</h2>
        
        <div class="error-layout">
            <div>
                <div style="font-weight:bold; font-size:0.8rem; color:#64748b; margin-bottom:8px;">1. SELECT PLAYER (Home Team)</div>
                <div class="player-chips" id="error-player-chips">
                    <span style="color:#999; font-size:0.8rem;">Fill in Roster on Tab 1 first.</span>
                </div>
            </div>
            <div class="error-action-area">
                <div>
                    <div style="font-weight:bold; font-size:0.8rem; color:#64748b; margin-bottom:8px;">2. TAP ERROR TYPE</div>
                    <div class="error-buttons">
                        <button class="err-btn bg-se" id="btn-err-se" onclick="addError('SE')" disabled>SE<span class="err-subtext">Serve</span></button>
                        <button class="err-btn bg-re" id="btn-err-re" onclick="addError('RE')" disabled>RE<span class="err-subtext">Receive</span></button>
                        <button class="err-btn bg-ae" id="btn-err-ae" onclick="addError('AE')" disabled>AE<span class="err-subtext">Attack</span></button>
                        <button class="err-btn bg-be" id="btn-err-be" onclick="addError('BE')" disabled>BE<span class="err-subtext">Block</span></button>
                        <button class="err-btn bg-bhe" id="btn-err-bhe" onclick="addError('BHE')" disabled>BHE<span class="err-subtext">Handling</span></button>
                        <button class="err-btn bg-fe" id="btn-err-fe" onclick="addError('FE')" disabled>FE<span class="err-subtext">Fault</span></button>
                    </div>
                </div>
                <div class="error-log-panel">
                    <div class="err-log-header">
                        <span>ERROR SUMMARY</span>
                        <div>
                            <button class="btn-undo-err" onclick="undoLastError()">Undo Last</button>
                            <button style="background:transparent; border:1px solid #ef4444; color:#ef4444; padding:3px 6px; border-radius:4px; font-size:0.65rem; cursor:pointer; margin-left:5px;" onclick="resetErrorsOnly()">Clear All</button>
                        </div>
                    </div>
                    <div id="error-summary-list">
                        <div style="text-align:center; color:#999; font-size:0.8rem; padding:10px;">No errors recorded</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="no-print" style="margin-top:20px;">
        <div class="btn-group">
            <button class="btn-main btn-update" onclick="generate()">Update Display</button>
            <select id="print-mode" class="print-select" onchange="updatePrintMode()">
                <option value="all">Print: All Tabs</option>
                <option value="rotations">Print: Rotations Only</option>
                <option value="analysis">Print: Analysis Only</option>
                <option value="errors">Print: Errors Only</option>
            </select>
            <button class="btn-main btn-print" onclick="window.print()">Print</button>
        </div>
        <div class="data-tools">
            <button class="btn-data btn-export" onclick="exportData()">Export Data</button>
            <button class="btn-data btn-import" onclick="document.getElementById('import-file').click()">Import Data</button>
            <input type="file" id="import-file" style="display:none" onchange="importData(this)">
            <button class="btn-data btn-reset-all" onclick="factoryReset()">FACTORY RESET</button>
        </div>
    </div>

    <div class="watermark">codedby03093msf</div>
</div>

<script>
    // --- AUTH ---
    function initAuth() {
        const u = sessionStorage.getItem('vb_user');
        if(u === 'admin') { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('app-container').style.display = 'block'; document.getElementById('current-user').innerText = 'Admin'; init(); }
    }
    function login() {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        if(u==='admin' && p==='admin123') { sessionStorage.setItem('vb_user', 'admin'); initAuth(); } 
        else document.getElementById('login-error').style.display='block';
    }
    function logout() { sessionStorage.removeItem('vb_user'); location.reload(); }

    // --- APP STATE ---
    let scoreA=0, scoreB=0, setsA=0, setsB=0;
    let history=[], serveStats=[], mapCount=1; 
    let timeouts={a:[false,false],b:[false,false]}, subCounts={a:0,b:0};
    let selectedErrorPlayer = null, errorStats = {}, errorHistory = [];

    const roles = `<option value="">-</option><option value="S">S</option><option value="OH">OH</option><option value="MB">MB</option><option value="OP">OP</option><option value="L">L</option><option value="DS">DS</option>`;
    const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#6366f1', '#a855f7', '#ec4899', '#14b8a6'];
    let playerColors = {}; 

    // --- TABS & PRINT MODE ---
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        const bs=document.querySelectorAll('.tab-btn');
        if(id==='rotations') bs[0].classList.add('active'); 
        else if (id==='analysis') bs[1].classList.add('active');
        else bs[2].classList.add('active');
    }
    function updatePrintMode() {
        const m = document.getElementById('print-mode').value;
        document.body.className = 'print-' + m;
    }

    // --- SCOREBOARD ---
    function adjScore(t,v){ if(t==='a')scoreA=Math.max(0,scoreA+v);else scoreB=Math.max(0,scoreB+v); updateScoreBoard(); saveAll(); }
    function toggleTO(t,n){ timeouts[t][n-1]=!timeouts[t][n-1]; updateScoreBoard(); saveAll(); }
    function adjSubs(t){ const v=prompt("Subs (0-12):",subCounts[t]); if(v!==null) { subCounts[t]=Math.min(12,Math.max(0,parseInt(v)||0)); updateScoreBoard(); saveAll(); } }
    function incrementSubCount(t) { if(subCounts[t]<12) { subCounts[t]++; updateScoreBoard(); } else alert("Max subs!"); }
    function finishSet(w){ 
        if(!confirm("Confirm Set Win?"))return; 
        const wStr = w==='a'?document.getElementById('name-a').value:document.getElementById('name-b').value;
        history.push(`Set ${history.length+1}: ${scoreA}-${scoreB} (${wStr})`); 
        if(w==='a')setsA++;else setsB++; 
        scoreA=0; scoreB=0; timeouts={a:[false,false],b:[false,false]}; subCounts={a:0,b:0}; 
        updateScoreBoard(); saveAll(); 
    }
    function resetPointsOnly(){ if(confirm("Reset Pts?")){scoreA=0;scoreB=0;updateScoreBoard();saveAll();} }
    function updateSet(t,v){ if(t==='a')setsA=Math.max(0,setsA+v);else setsB=Math.max(0,setsB+v); updateScoreBoard(); saveAll(); }
    function resetMatch(){
        if(confirm("Reset FULL MATCH?")) {
            scoreA=0; scoreB=0; setsA=0; setsB=0; history=[]; serveStats=[]; errorStats={}; errorHistory=[];
            timeouts={a:[false,false],b:[false,false]}; subCounts={a:0,b:0};
            renderServeMarks(); renderErrorStats(); updateScoreBoard(); saveAll();
        }
    }
    function updateScoreBoard(){
        document.getElementById('score-a-disp').innerText=scoreA; document.getElementById('score-b-disp').innerText=scoreB;
        document.getElementById('sets-a-disp').innerText=setsA; document.getElementById('sets-b-disp').innerText=setsB;
        for(let i=1;i<=2;i++){ document.getElementById(`to-a-${i}`).className=timeouts.a[i-1]?'to-dot active':'to-dot'; document.getElementById(`to-b-${i}`).className=timeouts.b[i-1]?'to-dot active':'to-dot'; }
        document.getElementById('subs-a-disp').innerText=`${subCounts.a}/12`; document.getElementById('subs-b-disp').innerText=`${subCounts.b}/12`;
        document.getElementById('history-list').innerHTML=history.length?history.map(s=>`<div class="history-chip">${s}</div>`).join(''):'<span style="opacity:0.5;font-size:0.8rem">No sets completed</span>';
    }
    function updateNames() {
        document.getElementById('sb-name-a').innerText=document.getElementById('name-a').value||'HOME';
        document.getElementById('sb-name-b').innerText=document.getElementById('name-b').value||'AWAY';
    }

    // --- ERROR TRACKING ---
    function updateErrorPlayerChips() {
        const roster = getRoster('a');
        const container = document.getElementById('error-player-chips');
        if(roster.length === 0) {
            container.innerHTML = '<span style="color:#999; font-size:0.8rem;">Fill in Team A Roster on Tab 1.</span>';
            selectedErrorPlayer = null; toggleErrorButtons(false); return;
        }
        container.innerHTML = '';
        roster.forEach(n => {
            const chip = document.createElement('div');
            chip.className = `player-chip ${n === selectedErrorPlayer ? 'active' : ''}`;
            chip.innerText = n; chip.onclick = () => selectErrorPlayer(n);
            container.appendChild(chip);
        });
        if(!roster.includes(selectedErrorPlayer)) { selectedErrorPlayer = null; toggleErrorButtons(false); }
    }
    function selectErrorPlayer(name) { selectedErrorPlayer = name; updateErrorPlayerChips(); toggleErrorButtons(true); }
    function toggleErrorButtons(enable) { document.querySelectorAll('.err-btn').forEach(b => b.disabled = !enable); }
    function addError(type) {
        if(!selectedErrorPlayer) return;
        if(!errorStats[selectedErrorPlayer]) errorStats[selectedErrorPlayer] = { SE:0, RE:0, AE:0, BE:0, BHE:0, FE:0 };
        errorStats[selectedErrorPlayer][type]++;
        errorHistory.push({ p: selectedErrorPlayer, e: type });
        renderErrorStats(); saveAll();
    }
    function undoLastError() {
        if(errorHistory.length === 0) return;
        const last = errorHistory.pop();
        if(errorStats[last.p] && errorStats[last.p][last.e] > 0) {
            errorStats[last.p][last.e]--;
            let total = 0; for(const v of Object.values(errorStats[last.p])) total += v;
            if(total === 0) delete errorStats[last.p];
        }
        renderErrorStats(); saveAll();
    }
    function resetErrorsOnly() { if(confirm("Clear all Error Tracking data?")) { errorStats={}; errorHistory=[]; renderErrorStats(); saveAll(); } }
    
    const errColors = { SE:'#f59e0b', RE:'#3b82f6', AE:'#ef4444', BE:'#8b5cf6', BHE:'#06b6d4', FE:'#64748b' };
    function renderErrorStats() {
        const list = document.getElementById('error-summary-list'); list.innerHTML = '';
        if(Object.keys(errorStats).length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; font-size:0.8rem; padding:10px;">No errors recorded</div>'; return; }
        for(const [player, stats] of Object.entries(errorStats)) {
            let badges = '';
            for(const [type, count] of Object.entries(stats)) {
                if(count > 0) badges += `<span class="e-badge" style="background-color:${errColors[type]}">${type}: ${count}</span>`;
            }
            if(badges) {
                const row = document.createElement('div'); row.className = 'err-player-row';
                row.innerHTML = `<span class="err-player-name">${player}</span><div class="err-badges">${badges}</div>`;
                list.appendChild(row);
            }
        }
    }


    // --- SERVE ANALYSIS ---
    function getColor(name) {
        if(!playerColors[name]) { const idx = Object.keys(playerColors).length % colors.length; playerColors[name] = colors[idx]; }
        return playerColors[name];
    }
    function addMap() {
        mapCount++; const c = document.getElementById('maps-container'); const id = mapCount-1;
        const div = document.createElement('div'); div.className = 'analysis-container'; div.id = `serve-court-${id}`; div.onclick = (e) => recordServe(e, id);
        div.innerHTML = `<div class="net-indicator"><span class="net-text-badge">NET (SET ${mapCount})</span></div><div class="analysis-grid"><div class="analysis-cell">4</div><div class="analysis-cell">3</div><div class="analysis-cell">2</div><div class="analysis-cell">7</div><div class="analysis-cell">8</div><div class="analysis-cell">9</div><div class="analysis-cell">5</div><div class="analysis-cell">6</div><div class="analysis-cell">1</div></div>`;
        c.appendChild(div); saveAll();
    }
    function recordServe(e, mapId) {
        const rect = e.currentTarget.getBoundingClientRect();
        const x = Math.min(98, Math.max(2, ((e.clientX - rect.left) / rect.width) * 100));
        const y = Math.min(98, Math.max(2, ((e.clientY - rect.top) / rect.height) * 100));
        const p = document.getElementById('serve-player-input').value.trim() || "Unk";
        serveStats.push({x, y, player: p, mapId: mapId}); renderAllMarks(); saveAll();
    }
    function undoServeMark(e) { e.stopPropagation(); serveStats.pop(); renderAllMarks(); saveAll(); }
    function resetAnalysisOnly() {
        if(confirm("Clear ALL Serve Analysis data?")) {
            serveStats = []; mapCount = 1;
            document.getElementById('maps-container').innerHTML = `<div class="analysis-container" id="serve-court-0" onclick="recordServe(event, 0)"><div class="net-indicator"><span class="net-text-badge">NET (SET 1)</span></div><div class="analysis-grid"><div class="analysis-cell">4</div><div class="analysis-cell">3</div><div class="analysis-cell">2</div><div class="analysis-cell">7</div><div class="analysis-cell">8</div><div class="analysis-cell">9</div><div class="analysis-cell">5</div><div class="analysis-cell">6</div><div class="analysis-cell">1</div></div></div>`;
            renderAllMarks(); saveAll();
        }
    }
    function renderAllMarks() {
        document.querySelectorAll('.serve-mark').forEach(m => m.remove());
        let stats = {};
        
        serveStats.forEach(s => {
            if(s.mapId >= mapCount) for(let i=mapCount; i<=s.mapId; i++) addMap();
            const container = document.getElementById(`serve-court-${s.mapId}`);
            if(container) {
                const mark = document.createElement('div'); mark.className = 'serve-mark';
                mark.style.left = s.x + '%'; mark.style.top = s.y + '%';
                mark.innerText = s.player; mark.style.backgroundColor = getColor(s.player);
                container.appendChild(mark);
            }
            if(!stats[s.player]) stats[s.player] = { count:0, zones:{} };
            stats[s.player].count++;
            const z = getZone(s.x, s.y);
            if(!stats[s.player].zones[z]) stats[s.player].zones[z]=0;
            stats[s.player].zones[z]++;
        });
        updateServerList(stats);
    }

    function getZone(x, y) {
        let col = Math.floor(x/33.34), row = Math.floor(y/33.34);
        const zm = [[4,3,2],[7,8,9],[5,6,1]];
        return zm[row]?zm[row][col]:'?';
    }

    function updateServerList(stats) {
        const l = document.getElementById('server-stats-list'); l.innerHTML='';
        if(Object.keys(stats).length===0) { l.innerHTML='<div style="text-align:center;color:#999;font-size:0.8rem;padding:10px;">No data</div>'; return; }
        
        for(const [n,d] of Object.entries(stats)) {
            const color = getColor(n); let badges = '', maxCount = 0;
            Object.values(d.zones).forEach(c => { if(c > maxCount) maxCount = c; });

            Object.keys(d.zones).sort((a,b)=>a-b).forEach(z => { 
                const isBest = d.zones[z] === maxCount;
                badges+=`<span class="stat-badge ${isBest?'best-zone':''}">Z${z}: ${d.zones[z]}</span>`;
            });
            
            const div = document.createElement('div'); div.className='server-item';
            div.onclick = () => { document.getElementById('serve-player-input').value = n; };
            div.innerHTML = `<div class="server-header"><div class="server-info"><div class="color-swatch" style="background:${color}"></div><span style="font-weight:bold">${n}</span></div><span class="total-badge">Total: ${d.count}</span></div><div class="stat-badges">${badges}</div>`;
            l.appendChild(div);
        }
    }

    // --- SETUP & GENERIC ---
    function init() {
        ['a','b'].forEach(t => {
            const r=document.getElementById(`roster-list-${t}`);
            for(let i=1;i<=12;i++) r.innerHTML+=`<div class="roster-row"><span>${i}</span><input type="text" id="p-${t}-${i}-name" placeholder="Name" oninput="handleRosterInput('${t}')"><select id="p-${t}-${i}-role" onchange="saveAll()">${roles}</select></div>`;
            const s=document.getElementById(`selectors-${t}`);
            for(let i=1;i<=6;i++) s.innerHTML+=`<div class="lineup-row"><label>Pos ${i}</label><select id="l-${t}-${i}" class="lineup-select" onchange="handleLineupChange('${t}')"></select><div class="icon-swap" onclick="doSwap('${t}',${i})">â‡„</div><select id="l-${t}-${i}-sub" class="lineup-select" onchange="handleLineupChange('${t}')"></select></div>`;
        });
        loadAll();
    }

    function getRoster(t) { let a=[]; for(let i=1;i<=12;i++){let n=document.getElementById(`p-${t}-${i}-name`).value.trim(); if(n) a.push(n);} return a.sort(); }
    function getActiveStarters(t) { let s=new Set(); for(let i=1;i<=6;i++){let v=document.getElementById(`l-${t}-${i}`).value; if(v) s.add(v);} return s; }
    function refreshDropdowns(t) {
        const r=getRoster(t), st=getActiveStarters(t);
        for(let i=1;i<=6;i++) {
            const m=document.getElementById(`l-${t}-${i}`), s=document.getElementById(`l-${t}-${i}-sub`);
            fillSelect(m,r,m.value,null); fillSelect(s,r,s.value,st);
        }
    }
    function fillSelect(el,names,cur,excl) {
        let h=`<option value="">${el.id.includes('sub')?'-Sub-':'-Start-'}</option>`;
        names.forEach(n=>{ if(!excl||!excl.has(n)||n===cur) h+=`<option value="${n}" ${n===cur?'selected':''}>${n}</option>`; });
        el.innerHTML=h;
    }
    function handleRosterInput(t){ saveAll(); refreshDropdowns(t); if(t==='a') updateErrorPlayerChips(); }
    function handleLineupChange(t){ saveAll(); refreshDropdowns(t); }
    function doSwap(t,p) {
        const m=document.getElementById(`l-${t}-${p}`), s=document.getElementById(`l-${t}-${p}-sub`);
        const om=m.value, os=s.value;
        if(os) {
            if(!m.querySelector(`option[value="${os}"]`)) m.innerHTML+=`<option value="${os}">${os}</option>`;
            if(om && !s.querySelector(`option[value="${om}"]`)) s.innerHTML+=`<option value="${om}">${om}</option>`;
            m.value=os; s.value=om; saveAll(); refreshDropdowns(t); generate();
        }
    }

    // --- DATA ---
    function saveAll() {
        const d={
            sA:scoreA, sB:scoreB, setsA:setsA, setsB:setsB, hist:history, tos:timeouts, subs:subCounts, serveStats:serveStats, mapCount: mapCount,
            errStats: errorStats, errHist: errorHistory,
            meta:{ nA:document.getElementById('name-a').value, nB:document.getElementById('name-b').value, date:document.getElementById('match-date').value, venue:document.getElementById('match-venue').value, oA:document.getElementById('start-offset-a').value, oB:document.getElementById('start-offset-b').value },
            rosA:getRosterObj('a'), rosB:getRosterObj('b'), linA:getLineupObj('a'), linB:getLineupObj('b')
        };
        localStorage.setItem('vb_pro_v22', JSON.stringify(d));
    }
    function getRosterObj(t){ let a=[]; for(let i=1;i<=12;i++) a.push({n:document.getElementById(`p-${t}-${i}-name`).value, r:document.getElementById(`p-${t}-${i}-role`).value}); return a; }
    function getLineupObj(t){ let a=[]; for(let i=1;i<=6;i++) a.push({m:document.getElementById(`l-${t}-${i}`).value, s:document.getElementById(`l-${t}-${i}-sub`).value}); return a; }
    
    function loadAll() {
        const j=localStorage.getItem('vb_pro_v22'); if(!j) return;
        const d=JSON.parse(j);
        scoreA=d.sA||0; scoreB=d.sB||0; setsA=d.setsA||0; setsB=d.setsB||0; history=d.hist||[]; 
        timeouts=d.tos||{a:[0,0],b:[0,0]}; subCounts=d.subs||{a:0,b:0}; 
        serveStats=d.serveStats||[]; mapCount = d.mapCount || 1; 
        errorStats=d.errStats||{}; errorHistory=d.errHist||[];
        
        // Restore maps
        const c = document.getElementById('maps-container');
        c.innerHTML = ''; 
        for(let i=0; i<mapCount; i++) {
            const div = document.createElement('div'); div.className = 'analysis-container'; div.id = `serve-court-${i}`; div.onclick = (e) => recordServe(e, i);
            div.innerHTML = `<div class="net-indicator"><span class="net-text-badge">NET (SET ${i+1})</span></div><div class="analysis-grid"><div class="analysis-cell">4</div><div class="analysis-cell">3</div><div class="analysis-cell">2</div><div class="analysis-cell">7</div><div class="analysis-cell">8</div><div class="analysis-cell">9</div><div class="analysis-cell">5</div><div class="analysis-cell">6</div><div class="analysis-cell">1</div></div>`;
            c.appendChild(div);
        }

        updateScoreBoard(); renderAllMarks(); renderErrorStats();
        
        if(d.meta) {
            document.getElementById('name-a').value=d.meta.nA; document.getElementById('name-b').value=d.meta.nB;
            document.getElementById('match-date').value=d.meta.date||''; document.getElementById('match-venue').value=d.meta.venue||'';
            document.getElementById('start-offset-a').value=d.meta.oA; document.getElementById('start-offset-b').value=d.meta.oB;
        }
        updateNames();
        restoreRoster('a',d.rosA); restoreRoster('b',d.rosB); refreshDropdowns('a'); refreshDropdowns('b'); restoreLineup('a',d.linA); restoreLineup('b',d.linB); generate();
        updateErrorPlayerChips();
    }
    function restoreRoster(t,a){ if(!a)return; a.forEach((p,i)=>{ if(i<12){document.getElementById(`p-${t}-${i+1}-name`).value=p.n; document.getElementById(`p-${t}-${i+1}-role`).value=p.r;} }); }
    function restoreLineup(t,a){ if(!a)return; a.forEach((l,i)=>{ const m=document.getElementById(`l-${t}-${i+1}`), s=document.getElementById(`l-${t}-${i+1}-sub`); if(l.m)m.innerHTML+=`<option value="${l.m}">${l.m}</option>`; if(l.s)s.innerHTML+=`<option value="${l.s}">${l.s}</option>`; m.value=l.m; s.value=l.s; }); refreshDropdowns(t); }
    function exportData() { saveAll(); const b=new Blob([localStorage.getItem('vb_pro_v22')],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`vb_data.json`; a.click(); }
    function importData(inp) { const f=inp.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{ try{const d=JSON.parse(e.target.result); if(!d.meta)throw 1; localStorage.setItem('vb_pro_v22',JSON.stringify(d)); location.reload();}catch(x){alert('Invalid File');} }; r.readAsText(f); }
    function factoryReset() { if(confirm("DELETE ALL?")) { localStorage.removeItem('vb_pro_v22'); location.reload(); } }

    function getRole(n,t){ for(let i=1;i<=12;i++) if(document.getElementById(`p-${t}-${i}-name`).value===n) return document.getElementById(`p-${t}-${i}-role`).value; return ''; }
    function generate() {
        const out=document.getElementById('output'), m=document.getElementById('view-mode').value;
        out.innerHTML=''; if(m!=='all') out.classList.add('single-view'); else out.classList.remove('single-view');
        let s=0, e=6; if(m!=='all'){ s=parseInt(m)-1; e=s+1; }
        const aA=buildArr('a'), aB=buildArr('b');
        const oA=parseInt(document.getElementById('start-offset-a').value), oB=parseInt(document.getElementById('start-offset-b').value);
        for(let r=s; r<e; r++) {
            const rA=rotate(aA,r+oA), rB=rotate(aB,r+oB);
            out.innerHTML+=`<div class="rotation-card"><div class="rot-title">ROTATION ${r+1}</div><div style="text-align:center;font-weight:bold;color:var(--primary);font-size:0.8rem">${document.getElementById('name-a').value}</div><div class="court-wrapper"><div class="court">${z(rA[3],0)}${z(rA[2],0)}${z(rA[1],0)}${z(rA[4],0)}${z(rA[5],0)}${z(rA[0],1)}</div></div><div style="text-align:center;font-weight:bold;color:var(--secondary);font-size:0.8rem">${document.getElementById('name-b').value}</div><div class="court-wrapper"><div class="court team-b-bg">${z(rB[3],0)}${z(rB[2],0)}${z(rB[1],0)}${z(rB[4],0)}${z(rB[5],0)}${z(rB[0],1)}</div></div></div>`;
        }
    }
    function buildArr(t){ let a=[]; for(let i=1;i<=6;i++){ let m=document.getElementById(`l-${t}-${i}`).value||`P${i}`, s=document.getElementById(`l-${t}-${i}-sub`).value; a.push({n:m,s:s,r:getRole(m,t)}); } return a; }
    function rotate(a,s){ let r=[...a]; for(let k=0;k<s;k++) r=[r[1],r[2],r[3],r[4],r[5],r[0]]; return r; }
    function z(p,ip1){ const l=p.r==='L'; return `<div class="zone" ${ip1?'style="border:2px solid #000"':''}>${ip1?'<div class="server-badge">S</div>':''}<span class="pos-label">${ip1?'P1':''}</span><div class="player-content">${p.r?`<span class="role-badge ${l?'libero':''}">${p.r}</span>`:''}<span>${p.n}</span>${p.s?`<span class="sub-name">(${p.s})</span>`:''}</div></div>`; }

    initAuth();
</script>
</body>
</html>
